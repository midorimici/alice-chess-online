(()=>{"use strict";var r={395:r=>{r.exports=require("socket.io")}},t={};function n(e){if(t[e])return t[e].exports;var i=t[e]={exports:{}};return r[e](i,i.exports,n),i.exports}(()=>{const r=require("express"),t=require("http");var e,i=function(){function r(r){this.v=r}return r.prototype.val=function(){return this.v},r.prototype.add=function(t){return Array.isArray(t)?new r([t[0]+this.v[0],t[1]+this.v[1]]):new r([t+this.v[0],t+this.v[1]])},r.prototype.mul=function(t){return new r([t*this.v[0],t*this.v[1]])},r.prototype.div=function(t){return new r([this.v[0]/t,this.v[1]/t])},r.prototype.quot=function(t){return new r([Math.floor(this.v[0]/t),Math.floor(this.v[1]/t)])},r}(),o=(e=function(r,t){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,t){r.__proto__=t}||function(r,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])})(r,t)},function(r,t){function n(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=function(r){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&r[t],e=0;if(n)return n.call(r);if(r&&"number"==typeof r.length)return{next:function(){return r&&e>=r.length&&(r=void 0),{value:r&&r[e++],done:!r}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},u=function(r,t){var n="function"==typeof Symbol&&r[Symbol.iterator];if(!n)return r;var e,i,o=n.call(r),a=[];try{for(;(void 0===t||t-- >0)&&!(e=o.next()).done;)a.push(e.value)}catch(r){i={error:r}}finally{try{e&&!e.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a},l=function(){function r(r,t){this.color=r,this.side=t}return r.prototype.inBoard=function(r){return r[0]>=0&&r[0]<8&&r[1]>=0&&r[1]<8},r.prototype.legal=function(r,t){var n;return this.inBoard(r)&&void 0===t.get(1-this.side+","+String(r))&&!((null===(n=t.get(this.side+","+String(r)))||void 0===n?void 0:n[0])===this.color)},r.prototype.rider=function(r,t,n){var e,i,o=[];try{for(var l=a(t),c=l.next();!c.done;c=l.next())for(var s=u(c.value,2),f=s[0],p=s[1],h=r[0]+f,v=r[1]+p;this.inBoard([h,v]);){var d=n.get(this.side+","+h+","+v);if(!n.get(1-this.side+","+h+","+v)){if(d){if(d[0]!==this.color){o.push([h,v]);break}break}o.push([h,v])}h+=f,v+=p}}catch(r){e={error:r}}finally{try{c&&!c.done&&(i=l.return)&&i.call(l)}finally{if(e)throw e.error}}return o},r.prototype.validMoves=function(r,t,n,e){var i,o,u,l,c=[],s=this.coveringSquares(r,t);if("K"===this.abbr)try{for(var f=a([0,1]),p=f.next();!p.done;p=f.next()){var g=p.value,w="W"===this.color?0===g?[2,7]:[6,7]:0===g?[5,7]:[1,7];d(e,this.color,g,this.side,w,t)&&s.push(w)}}catch(r){i={error:r}}finally{try{p&&!p.done&&(o=f.return)&&o.call(f)}finally{if(i)throw i.error}}n&&(w=[7-n[1],7-n[2]-1],y(r,w,this.abbr,this.side,n[0],t)&&s.push(w));try{for(var b=a(s),S=b.next();!S.done;S=b.next()){var x=S.value,M=new Map(t);if("K"===this.abbr){var B=new Map(t);if(B.set(this.side+","+String(x),this.color+"K"),B.delete(this.side+","+String(r)),v(this.color,h(B)))continue}m(this.side,r,x,M),v(this.color,h(M))||c.push(x)}}catch(r){u={error:r}}finally{try{S&&!S.done&&(l=b.return)&&l.call(b)}finally{if(u)throw u.error}}return c},r}(),c={N:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="N",t}return o(t,r),t.prototype.coveringSquares=function(r,t){var n=this;return[[1,2],[2,1],[2,-1],[1,-2],[-1,-2],[-2,-1],[-2,1],[-1,2]].map((function(t){return new i(r).add(t).val()})).filter((function(r){return n.legal(r,t)}))},t}(l),B:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="B",t}return o(t,r),t.prototype.coveringSquares=function(r,t){return this.rider(r,[[1,1],[1,-1],[-1,-1],[-1,1]],t)},t}(l),R:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="R",t}return o(t,r),t.prototype.coveringSquares=function(r,t){return this.rider(r,[[1,0],[0,-1],[-1,0],[0,1]],t)},t}(l),Q:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="Q",t}return o(t,r),t.prototype.coveringSquares=function(r,t){return this.rider(r,[[1,1],[1,-1],[-1,-1],[-1,1],[1,0],[0,-1],[-1,0],[0,1]],t)},t}(l),K:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="K",t}return o(t,r),t.prototype.coveringSquares=function(r,t){var n=this;return[[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1],[1,1]].map((function(t){return new i(r).add(t).val()})).filter((function(r){return n.legal(r,t)}))},t}(l),P:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="P",t}return o(t,r),t.prototype.coveringSquares=function(r,t){var n,e,o=[],a=new i(r).add([1,-1]).val();(null===(n=t.get(this.side+","+String(a)))||void 0===n?void 0:n[0])===p[this.color]&&o.push(a),a=new i(r).add([-1,-1]).val(),(null===(e=t.get(this.side+","+String(a)))||void 0===e?void 0:e[0])===p[this.color]&&o.push(a),a=new i(r).add([0,-1]).val(),!t.has(this.side+","+String(a))&&this.legal(a,t)&&o.push(a);var u=new i(r).add([0,-2]).val();return 6!==r[1]||t.has(this.side+","+String(a))||t.has(this.side+","+String(u))||!this.legal(u,t)||o.push(u),o},t}(l)},s=function(r){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&r[t],e=0;if(n)return n.call(r);if(r&&"number"==typeof r.length)return{next:function(){return r&&e>=r.length&&(r=void 0),{value:r&&r[e++],done:!r}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},f=function(r,t){var n="function"==typeof Symbol&&r[Symbol.iterator];if(!n)return r;var e,i,o=n.call(r),a=[];try{for(;(void 0===t||t-- >0)&&!(e=o.next()).done;)a.push(e.value)}catch(r){i={error:r}}finally{try{e&&!e.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a},p={W:"B",B:"W"},h=function(r){var t,n,e=r,i=new Map;try{for(var o=s(e.entries()),a=o.next();!a.done;a=o.next()){var u=f(a.value,2),l=u[0],c=u[1],p=f(l.split(",").map((function(r){return+r})),3),h=p[0],v=p[1],d=p[2];i.set(h+","+(7-v)+","+(7-d),c)}}catch(r){t={error:r}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return i},v=function(r,t){var n,e,i,o,a,u,l,h=new Map;try{for(var v=s(t.entries()),d=v.next();!d.done;d=v.next()){var y=f(d.value,2),m=y[0];if((S=y[1])===r+"K"){l=m.split(",").map((function(r){return+r}));break}}}catch(r){n={error:r}}finally{try{d&&!d.done&&(e=v.return)&&e.call(v)}finally{if(n)throw n.error}}try{for(var g=s(t.entries()),w=g.next();!w.done;w=g.next()){var b=f(w.value,2),S=(m=b[0],b[1]);if(l[0]===+m[0]&&S[0]!==r){var x=m.split(",").map((function(r){return+r}));h.set([x[1],x[2]],new c[S[1]](p[r],+m[0]))}}}catch(r){i={error:r}}finally{try{w&&!w.done&&(o=g.return)&&o.call(g)}finally{if(i)throw i.error}}try{for(var M=s(h.entries()),B=M.next();!B.done;B=M.next()){var q=f(B.value,2);if(m=q[0],~(S=q[1]).coveringSquares(m,t).map((function(r){return String(r)})).indexOf(String(l.slice(1))))return!0}}catch(r){a={error:r}}finally{try{B&&!B.done&&(u=M.return)&&u.call(M)}finally{if(a)throw a.error}}return!1},d=function(r,t,n,e,i,o){var a,u=function(r){var n=new Map(o),e=f(r.split(","),3),i=e[0],a=(e[1],e[2]);return n.set(r,t+"K"),n.delete(i+","+c(4)+","+a),n},l=function(r){var n,i;try{for(var o=s(r),a=o.next();!a.done;a=o.next()){var l=a.value;if(v(t,h(u(e+","+l+",7"))))return!1}}catch(r){n={error:r}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return!0},c=function(r){return"W"===t?r:7-r},p=r[t][n]&&!v(t,h(o))&&o.get(e+","+7*n+",7")===t+"R";return a=0===n?String(i)===c(2)+",7"&&!o.has(e+","+c(1)+",7")&&!o.has(e+","+c(2)+",7")&&!o.has(e+","+c(3)+",7")&&!o.has(1-e+","+c(2)+",7")&&!o.has(1-e+","+c(3)+",7")&&l([c(2),c(3)]):String(i)===c(6)+",7"&&!o.has(e+","+c(6)+",7")&&!o.has(e+","+c(5)+",7")&&!o.has(1-e+","+c(6)+",7")&&!o.has(1-e+","+c(5)+",7")&&l([c(6),c(5)]),p&&a},y=function(r,t,n,e,i,o){return"P"===n&&e===i&&!o.has(e+","+String(t))&&r[1]===t[1]+1&&1===Math.abs(r[0]-t[0])},m=function(r,t,n,e){e.set(1-r+","+String(n),e.get(r+","+String(t))),e.delete(r+","+String(t)),e.delete(r+","+String(n))},g=function(r,t){var n="function"==typeof Symbol&&r[Symbol.iterator];if(!n)return r;var e,i,o=n.call(r),a=[];try{for(;(void 0===t||t-- >0)&&!(e=o.next()).done;)a.push(e.value)}catch(r){i={error:r}}finally{try{e&&!e.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a},w=function(){for(var r=[],t=0;t<arguments.length;t++)r=r.concat(g(arguments[t]));return r},b=r();b.use(r.static(process.cwd()+"/public"));var S=t.createServer(b),x=n(395)(S,{cors:{origin:"https://alice-chess-online.netlify.app",methods:["GET","POST"]}});b.get("/",(function(r,t){t.sendFile(process.cwd()+"/public/ja/index.html")}));var M=new Map,B=function(){for(var r=new Map,t="RNBQKBNR",n=0;n<8;n++)r.set("0,"+n+",7","W"+t[n]),r.set("0,"+n+",6","WP"),r.set("0,"+n+",0","B"+t[n]),r.set("0,"+n+",1","BP");return r};x.on("connection",(function(r){r.on("enter room",(function(t){var n,e,i,o;r.info=t;var a=Array.from(M.keys()).filter((function(r){return" "===r[0]})),u=a.filter((function(r){return"waiting"===M.get(r).state})),l=a.filter((function(r){return"playing"===M.get(r).state})),c="play"===t.role?u:l.length?l:u,s=t.private?t.roomId:null!==(o=c[Math.floor(Math.random()*c.length)])&&void 0!==o?o:function(){for(var r=" "+String(Math.random()).slice(-3);M.has(r);)r=" "+String(Math.random()).slice(-3);return r}();r.info.roomId=s;var f=M.get(s);if("play"===t.role)if(f)if("waiting"===f.state){var p=f.players;p[1]={name:t.name,id:r.id},f.state="playing",r.join(s),f.boards=[B(),new Map],f.boards[1]=h(f.boards[0]);var v=f.boards;(n=x.to(s)).emit.apply(n,w(["watch",w(v[0])],p.map((function(r){return r.name})),[f.curTurn,!1])),(e=x.to(p[0].id)).emit.apply(e,w(["game",w(v[0]),"W",!0],p.map((function(r){return r.name})),[!1,null,f.canCastle])),(i=x.to(p[1].id)).emit.apply(i,w(["game",w(v[1]),"B",!1],p.map((function(r){return r.name})),[!1,null,f.canCastle])),r.emit("audience i/o",f.watchersNum)}else r.emit("room full",s),r.info.role="watch";else M.set(s,{players:[{name:t.name,id:r.id},{name:"",id:""}],watchersNum:0,state:"waiting",boards:null,curTurn:0,winner:null,canCastle:{W:[!0,!0],B:[!0,!0]}}),r.join(s),r.emit("wait opponent");else f?(r.join(s),"waiting"===f.state?r.emit("wait opponent"):null==f.winner?r.emit.apply(r,w(["watch",w(f.boards[0])],f.players.map((function(r){return r.name})),[f.curTurn,!1])):(r.emit.apply(r,w(["watch",w(f.boards[0])],f.players.map((function(r){return r.name})),[f.curTurn,!1,!0])),r.emit("tell winner",f.players.map((function(r){return r.name}))[f.winner])),f.watchersNum++,x.to(s).emit("audience i/o",f.watchersNum)):t.private?r.emit("no private room",s):r.emit("no public room")})),r.on("move piece",(function(t,n,e,i){var o,a,u,l,p,d,b,S,B=r.info.roomId,q=M.get(B),T=q.players,N=q.boards,I=q.curTurn,O=q.canCastle,P=["W","B"],W=N[I],j=null===(S=W.get(t+","+String(n)))||void 0===S?void 0:S[1];if("R"===j&&("0,7"===String(n)&&(O[P[I]][I]=!1),"7,7"===String(n)&&(O[P[I]][1-I]=!1)),"K"===j&&(O[P[I]]=[!1,!1],2===Math.abs(e[0]-n[0]))){var K=void 0,k=void 0;switch(e[0]){case 2:K=(o=g([3,0],2))[0],k=o[1];break;case 6:K=(a=g([5,7],2))[0],k=a[1];break;case 5:K=(u=g([4,7],2))[0],k=u[1];break;case 1:K=(l=g([2,0],2))[0],k=l[1]}W.set(1-t+","+K+",7",P[I]+"R"),W.delete(t+","+k+",7")}y(n,e,j,t,t,W)&&W.delete(t+","+e[0]+","+(e[1]+1));var R="P"===j&&n[1]-e[1]==2?w([1-t],e):null;m(t,n,e,W),i&&W.set(1-t+","+String(e),P[I]+i),N[1-I]=h(W),q.curTurn=1-I,I=q.curTurn;var _=v(P[I],N[1-I]);(function(r,t,n,e){var i,o,a,u;try{for(var l=s(t.entries()),p=l.next();!p.done;p=l.next()){var d=f(p.value,2),y=d[0],g=d[1];if(r===g[0]){var w=y.split(",").map((function(r){return+r})),b=new c[g[1]](r,w[0]);try{for(var S=(a=void 0,s(b.validMoves([w[1],w[2]],t,n,e))),x=S.next();!x.done;x=S.next()){var M=x.value,B=new Map(t);if(m(w[0],[w[1],w[2]],M,B),!v(r,h(B)))return!1}}catch(r){a={error:r}}finally{try{x&&!x.done&&(u=S.return)&&u.call(S)}finally{if(a)throw a.error}}}}}catch(r){i={error:r}}finally{try{p&&!p.done&&(o=l.return)&&o.call(l)}finally{if(i)throw i.error}}return!0})(P[I],N[I],R,O)&&(q.winner=_?1-I:2),(p=x.to(B)).emit.apply(p,w(["watch",w(N[0])],T.map((function(r){return r.name})),[I,_])),(d=x.to(T[0].id)).emit.apply(d,w(["game",w(N[0]),"W",0===I],T.map((function(r){return r.name})),[_,R,O])),(b=x.to(T[1].id)).emit.apply(b,w(["game",w(N[1]),"B",1===I],T.map((function(r){return r.name})),[_,R,O])),null!=q.winner&&x.to(B).emit("tell winner",T.map((function(r){return r.name}))[q.winner])})),r.on("chat message",(function(t){x.to(r.info.roomId).emit("chat message",t,"play"===r.info.role,r.info.name)})),r.on("disconnect",(function(){var t=r.info;if(t){var n=M.get(t.roomId);n&&("play"===t.role?(M.delete(t.roomId),r.to(t.roomId).leave(t.roomId),r.to(t.roomId).emit("player discon",t.name)):(n.watchersNum=Math.max(n.watchersNum-1,0),x.to(t.roomId).emit("audience i/o",n.watchersNum)))}}))})),S.listen(process.env.PORT||3e3)})()})();