(()=>{"use strict";var r={395:r=>{r.exports=require("socket.io")}},t={};function n(e){if(t[e])return t[e].exports;var o=t[e]={exports:{}};return r[e](o,o.exports,n),o.exports}(()=>{const r=require("express"),t=require("http");var e,o=function(){function r(r){this.v=r}return r.prototype.val=function(){return this.v},r.prototype.add=function(t){return Array.isArray(t)?new r([t[0]+this.v[0],t[1]+this.v[1]]):new r([t+this.v[0],t+this.v[1]])},r.prototype.mul=function(t){return new r([t*this.v[0],t*this.v[1]])},r.prototype.div=function(t){return new r([this.v[0]/t,this.v[1]/t])},r.prototype.quot=function(t){return new r([Math.floor(this.v[0]/t),Math.floor(this.v[1]/t)])},r}(),i=(e=function(r,t){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,t){r.__proto__=t}||function(r,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])})(r,t)},function(r,t){function n(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=function(r){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&r[t],e=0;if(n)return n.call(r);if(r&&"number"==typeof r.length)return{next:function(){return r&&e>=r.length&&(r=void 0),{value:r&&r[e++],done:!r}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},l=function(r,t){var n="function"==typeof Symbol&&r[Symbol.iterator];if(!n)return r;var e,o,i=n.call(r),a=[];try{for(;(void 0===t||t-- >0)&&!(e=i.next()).done;)a.push(e.value)}catch(r){o={error:r}}finally{try{e&&!e.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},u=function(){function r(r,t){this.color=r,this.side=t}return r.prototype.inBoard=function(r){return r[0]>=0&&r[0]<8&&r[1]>=0&&r[1]<8},r.prototype.legal=function(r,t){var n;return this.inBoard(r)&&void 0===t.get(1-this.side+","+String(r))&&!((null===(n=t.get(this.side+","+String(r)))||void 0===n?void 0:n[0])===this.color)},r.prototype.rider=function(r,t,n){var e,o,i=[];try{for(var u=a(t),s=u.next();!s.done;s=u.next())for(var c=l(s.value,2),f=c[0],p=c[1],h=r[0]+f,v=r[1]+p;this.inBoard([h,v]);){var d=n.get(this.side+","+h+","+v);if(!n.get(1-this.side+","+h+","+v)){if(d){if(d[0]!==this.color){i.push([h,v]);break}break}i.push([h,v])}h+=f,v+=p}}catch(r){e={error:r}}finally{try{s&&!s.done&&(o=u.return)&&o.call(u)}finally{if(e)throw e.error}}return i},r.prototype.validMoves=function(r,t,n,e){var o,i,l,u,s=[],c=this.coveringSquares(r,t);if("K"===this.abbr)try{for(var f=a([0,1]),p=f.next();!p.done;p=f.next()){var g=p.value,w="W"===this.color?0===g?[2,7]:[6,7]:0===g?[5,7]:[1,7];d(e,this.color,g,this.side,w,t)&&c.push(w)}}catch(r){o={error:r}}finally{try{p&&!p.done&&(i=f.return)&&i.call(f)}finally{if(o)throw o.error}}n&&(w=[7-n[1],7-n[2]-1],y(r,w,this.abbr,this.side,n[0],t)&&c.push(w));try{for(var b=a(c),S=b.next();!S.done;S=b.next()){var x=S.value,B=new Map(t);if("K"===this.abbr){var M=new Map(t);if(M.set(this.side+","+String(x),this.color+"K"),M.delete(this.side+","+String(r)),v(this.color,h(M)))continue}m(this.side,r,x,B),v(this.color,h(B))||s.push(x)}}catch(r){l={error:r}}finally{try{S&&!S.done&&(u=b.return)&&u.call(b)}finally{if(l)throw l.error}}return s},r}(),s={N:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="N",t}return i(t,r),t.prototype.coveringSquares=function(r,t){var n=this;return[[1,2],[2,1],[2,-1],[1,-2],[-1,-2],[-2,-1],[-2,1],[-1,2]].map((function(t){return new o(r).add(t).val()})).filter((function(r){return n.legal(r,t)}))},t}(u),B:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="B",t}return i(t,r),t.prototype.coveringSquares=function(r,t){return this.rider(r,[[1,1],[1,-1],[-1,-1],[-1,1]],t)},t}(u),R:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="R",t}return i(t,r),t.prototype.coveringSquares=function(r,t){return this.rider(r,[[1,0],[0,-1],[-1,0],[0,1]],t)},t}(u),Q:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="Q",t}return i(t,r),t.prototype.coveringSquares=function(r,t){return this.rider(r,[[1,1],[1,-1],[-1,-1],[-1,1],[1,0],[0,-1],[-1,0],[0,1]],t)},t}(u),K:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="K",t}return i(t,r),t.prototype.coveringSquares=function(r,t){var n=this;return[[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1],[1,1]].map((function(t){return new o(r).add(t).val()})).filter((function(r){return n.legal(r,t)}))},t}(u),P:function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.abbr="P",t}return i(t,r),t.prototype.coveringSquares=function(r,t){var n,e,i=[],a=new o(r).add([1,-1]).val();(null===(n=t.get(this.side+","+String(a)))||void 0===n?void 0:n[0])===p[this.color]&&i.push(a),a=new o(r).add([-1,-1]).val(),(null===(e=t.get(this.side+","+String(a)))||void 0===e?void 0:e[0])===p[this.color]&&i.push(a),a=new o(r).add([0,-1]).val(),!t.has(this.side+","+String(a))&&this.legal(a,t)&&i.push(a);var l=new o(r).add([0,-2]).val();return 6!==r[1]||t.has(this.side+","+String(a))||t.has(this.side+","+String(l))||!this.legal(l,t)||i.push(l),i},t}(u)},c=function(r){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&r[t],e=0;if(n)return n.call(r);if(r&&"number"==typeof r.length)return{next:function(){return r&&e>=r.length&&(r=void 0),{value:r&&r[e++],done:!r}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},f=function(r,t){var n="function"==typeof Symbol&&r[Symbol.iterator];if(!n)return r;var e,o,i=n.call(r),a=[];try{for(;(void 0===t||t-- >0)&&!(e=i.next()).done;)a.push(e.value)}catch(r){o={error:r}}finally{try{e&&!e.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},p={W:"B",B:"W"},h=function(r){var t,n,e=r,o=new Map;try{for(var i=c(e.entries()),a=i.next();!a.done;a=i.next()){var l=f(a.value,2),u=l[0],s=l[1],p=f(u.split(",").map((function(r){return+r})),3),h=p[0],v=p[1],d=p[2];o.set(h+","+(7-v)+","+(7-d),s)}}catch(r){t={error:r}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return o},v=function(r,t){var n,e,o,i,a,l,u,h=new Map;try{for(var v=c(t.entries()),d=v.next();!d.done;d=v.next()){var y=f(d.value,2),m=y[0];if((S=y[1])===r+"K"){u=m.split(",").map((function(r){return+r}));break}}}catch(r){n={error:r}}finally{try{d&&!d.done&&(e=v.return)&&e.call(v)}finally{if(n)throw n.error}}try{for(var g=c(t.entries()),w=g.next();!w.done;w=g.next()){var b=f(w.value,2),S=(m=b[0],b[1]);if(u[0]===+m[0]&&S[0]!==r){var x=m.split(",").map((function(r){return+r}));h.set([x[1],x[2]],new s[S[1]](p[r],+m[0]))}}}catch(r){o={error:r}}finally{try{w&&!w.done&&(i=g.return)&&i.call(g)}finally{if(o)throw o.error}}try{for(var B=c(h.entries()),M=B.next();!M.done;M=B.next()){var I=f(M.value,2);if(m=I[0],~(S=I[1]).coveringSquares(m,t).map((function(r){return String(r)})).indexOf(String(u.slice(1))))return!0}}catch(r){a={error:r}}finally{try{M&&!M.done&&(l=B.return)&&l.call(B)}finally{if(a)throw a.error}}return!1},d=function(r,t,n,e,o,i){var a,l=function(r){var n=new Map(i),e=f(r.split(","),3),o=e[0],a=(e[1],e[2]);return n.set(r,t+"K"),n.delete(o+","+s(4)+","+a),n},u=function(r){var n,o;try{for(var i=c(r),a=i.next();!a.done;a=i.next()){var u=a.value;if(v(t,h(l(e+","+u+",7"))))return!1}}catch(r){n={error:r}}finally{try{a&&!a.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}return!0},s=function(r){return"W"===t?r:7-r},p=r[t][n]&&!v(t,h(i))&&i.get(e+","+7*n+",7")===t+"R";return a=0===n?String(o)===s(2)+",7"&&!i.has(e+","+s(1)+",7")&&!i.has(e+","+s(2)+",7")&&!i.has(e+","+s(3)+",7")&&!i.has(1-e+","+s(2)+",7")&&!i.has(1-e+","+s(3)+",7")&&u([s(2),s(3)]):String(o)===s(6)+",7"&&!i.has(e+","+s(6)+",7")&&!i.has(e+","+s(5)+",7")&&!i.has(1-e+","+s(6)+",7")&&!i.has(1-e+","+s(5)+",7")&&u([s(6),s(5)]),p&&a},y=function(r,t,n,e,o,i){return"P"===n&&e===o&&!i.has(e+","+String(t))&&r[1]===t[1]+1&&1===Math.abs(r[0]-t[0])},m=function(r,t,n,e){e.set(1-r+","+String(n),e.get(r+","+String(t))),e.delete(r+","+String(t)),e.delete(r+","+String(n))},g=function(r,t){var n="function"==typeof Symbol&&r[Symbol.iterator];if(!n)return r;var e,o,i=n.call(r),a=[];try{for(;(void 0===t||t-- >0)&&!(e=i.next()).done;)a.push(e.value)}catch(r){o={error:r}}finally{try{e&&!e.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},w=function(){for(var r=[],t=0;t<arguments.length;t++)r=r.concat(g(arguments[t]));return r},b=r();b.use(r.static(process.cwd()+"/public"));var S=t.createServer(b),x=n(395)(S,{cors:{origin:"https://alice-chess-online.netlify.app",methods:["GET","POST"]}});b.get("/",(function(r,t){t.sendFile(process.cwd()+"/public/ja/index.html")}));var B=new Map,M=function(){for(var r=new Map,t="RNBQKBNR",n=0;n<8;n++)r.set("0,"+n+",7","W"+t[n]),r.set("0,"+n+",6","WP"),r.set("0,"+n+",0","B"+t[n]),r.set("0,"+n+",1","BP");return r};x.on("connection",(function(r){r.on("enter room",(function(t){var n,e,o;r.info=t;var i=B.get(t.roomId);if("play"===t.role)if(i)if("waiting"===i.state){var a=i.players;a[1]={name:t.name,id:r.id},i.state="playing",r.join(t.roomId),i.boards=[M(),new Map],i.boards[1]=h(i.boards[0]);var l=i.boards;(n=x.to(t.roomId)).emit.apply(n,w(["watch",w(l[0])],a.map((function(r){return r.name})),[i.curTurn,!1])),(e=x.to(a[0].id)).emit.apply(e,w(["game",w(l[0]),"W",!0],a.map((function(r){return r.name})),[!1,null,i.canCastle])),(o=x.to(a[1].id)).emit.apply(o,w(["game",w(l[1]),"B",!1],a.map((function(r){return r.name})),[!1,null,i.canCastle]))}else r.emit("room full",t.roomId),r.info.role="watch";else B.set(t.roomId,{players:[{name:t.name,id:r.id},{name:"",id:""}],state:"waiting",boards:null,curTurn:0,winner:null,canCastle:{W:[!0,!0],B:[!0,!0]}}),r.join(t.roomId),r.emit("wait opponent");else i?(r.join(t.roomId),"waiting"===i.state?r.emit("wait opponent"):null==i.winner?r.emit.apply(r,w(["watch",w(i.boards[0])],i.players.map((function(r){return r.name})),[i.curTurn,!1])):(r.emit.apply(r,w(["watch",w(i.boards[0])],i.players.map((function(r){return r.name})),[i.curTurn,!1,!0])),r.emit("tell winner",i.players.map((function(r){return r.name}))[i.winner]))):r.emit("no room",t.roomId)})),r.on("move piece",(function(t,n,e,o){var i,a,l,u,p,d,b,S,M=r.info.roomId,I=B.get(M),q=I.players,T=I.boards,O=I.curTurn,P=I.canCastle,W=["W","B"],j=T[O],K=null===(S=j.get(t+","+String(n)))||void 0===S?void 0:S[1];if("R"===K&&("0,7"===String(n)&&(P[W[O]][O]=!1),"7,7"===String(n)&&(P[W[O]][1-O]=!1)),"K"===K&&(P[W[O]]=[!1,!1],2===Math.abs(e[0]-n[0]))){var R=void 0,_=void 0;switch(e[0]){case 2:R=(i=g([3,0],2))[0],_=i[1];break;case 6:R=(a=g([5,7],2))[0],_=a[1];break;case 5:R=(l=g([4,7],2))[0],_=l[1];break;case 1:R=(u=g([2,0],2))[0],_=u[1]}j.set(1-t+","+R+",7",W[O]+"R"),j.delete(t+","+_+",7")}y(n,e,K,t,t,j)&&j.delete(t+","+e[0]+","+(e[1]+1));var k="P"===K&&n[1]-e[1]==2?w([1-t],e):null;m(t,n,e,j),o&&j.set(1-t+","+String(e),W[O]+o),T[1-O]=h(j),I.curTurn=1-O,O=I.curTurn;var C=v(W[O],T[1-O]);(function(r,t,n,e){var o,i,a,l;try{for(var u=c(t.entries()),p=u.next();!p.done;p=u.next()){var d=f(p.value,2),y=d[0],g=d[1];if(r===g[0]){var w=y.split(",").map((function(r){return+r})),b=new s[g[1]](r,w[0]);try{for(var S=(a=void 0,c(b.validMoves([w[1],w[2]],t,n,e))),x=S.next();!x.done;x=S.next()){var B=x.value,M=new Map(t);if(m(w[0],[w[1],w[2]],B,M),!v(r,h(M)))return!1}}catch(r){a={error:r}}finally{try{x&&!x.done&&(l=S.return)&&l.call(S)}finally{if(a)throw a.error}}}}}catch(r){o={error:r}}finally{try{p&&!p.done&&(i=u.return)&&i.call(u)}finally{if(o)throw o.error}}return!0})(W[O],T[O],k,P)&&(I.winner=C?1-O:2),(p=x.to(M)).emit.apply(p,w(["watch",w(T[0])],q.map((function(r){return r.name})),[O,C])),(d=x.to(q[0].id)).emit.apply(d,w(["game",w(T[0]),"W",0===O],q.map((function(r){return r.name})),[C,k,P])),(b=x.to(q[1].id)).emit.apply(b,w(["game",w(T[1]),"B",1===O],q.map((function(r){return r.name})),[C,k,P])),null!=I.winner&&x.to(M).emit("tell winner",q.map((function(r){return r.name}))[I.winner])})),r.on("chat message",(function(t){x.to(r.info.roomId).emit("chat message",t,"play"===r.info.role,r.info.name)})),r.on("disconnect",(function(){var t=r.info;t&&"play"===t.role&&(B.delete(t.roomId),r.to(t.roomId).leave(t.roomId),r.to(t.roomId).emit("player discon",t.name))}))})),S.listen(process.env.PORT||3e3)})()})();